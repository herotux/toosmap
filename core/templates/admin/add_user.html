{% extends 'admin/base.html' %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/add-user.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<!-- افزودن Select2 برای فیلدهای جستجوپذیر -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<!-- اضافه کردن CSS Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- اضافه کردن JavaScript Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
    /* استایل‌های کلی */
    .container {
        width: 100%;
        margin: 20px auto;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: center; /* فرم را در وسط قرار می‌دهد */
    }

    /* فرم اصلی */
    #user-form {
        max-width: 600px; /* عرض فرم محدود می‌شود */
        width: 100%; /* در صفحه‌های کوچک عرض فرم 100% می‌شود */
    }

    /* هدر فرم بدون flexbox */
    .form-header {
        background-color: #bfdefd;
        color: #333;
        padding: 15px 25px;
        border-radius: 8px 8px 0 0;
        margin: -20px -20px 20px -20px;
        display: block; /* تغییر از flex به block */
    }

    .form-header h2 {
        margin: 0;
        font-size: 18px;
        color: #333;
    }

    .form-header a {
        text-decoration: none;
        color: #333;
        float: right; /* چینش لینک به سمت راست */
    }

    /* پیام خطا بدون flexbox */
    .error-message {
        background-color: #ffebee;
        color: #c62828;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 15px;
        display: block; /* تغییر از flex به block */
    }

    /* استایل‌های فرم با flexbox */
    .form-group {
        margin-bottom: 15px;
        display: flex; /* استفاده از flexbox */
        align-items: center;
        gap: 10px; /* فاصله یکنواخت بین لیبل و فیلد ورودی */
    }

    .form-group label {
        flex: 1;
        font-weight: bold;
    }

    .form-group input,
    .form-group select {
        flex: 2;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        direction: rtl;
        background-color: #fff;
        color: gray; /* تغییر رنگ متن به خاکستری */
    }

    .form-group input[type="checkbox"] {
        flex: none;
        margin-left: 10px;
    }

    /* استایل‌های بخش تاریخ تولد با flexbox */
    .form-row {
        display: flex; /* استفاده از flexbox */
        gap: 10px; /* فاصله یکنواخت بین فیلدها */
        margin-bottom: 15px;
        flex: 2; /* عرض form-row برابر با عرض سایر فیلدها */
    }

    .form-row .form-group {
        flex: 1; /* تقسیم فضای مساوی بین فیلدها */
        margin-bottom: 0;
    }

    .form-row select {
        width: 100%;
        box-sizing: border-box;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        direction: rtl;
        color: gray; /* تغییر رنگ متن به خاکستری */
    }

    .form-row label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }

    /* استایل‌های دکمه ارسال */
    .btn-submit {
        width: 100%;
        padding: 10px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
        font-size: 16px;
    }

    .btn-submit:hover {
        background-color: #45a049;
    }

    /* استایل‌های آیکون */
    .stop-icon {
        font-size: 24px;
        color: #ff0000;
        background: white;
        border-radius: 50%;
        padding: 8px;
        box-shadow: 0 0 8px rgba(255, 0, 0, 0.3);
        cursor: pointer;
    }

    .stop-icon:hover {
        transform: scale(1.1);
        transition: 0.3s;
    }

    .container_header {
        display: block;
    }

    /* هدر آبی */
    .form-header {
        background-color: #bfdefd;
        color: white;
        padding: 15px 25px;
        border-radius: 8px 8px 0 0;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between; /* عناصر را در دو طرف قرار میدهد */
        align-items: center;
    }

    .form-header h2 {
        margin: 0;
        font-size: 18px;
    }

    .form-group input,
    .form-group select {
        color: gray;
    }

    /* ریسپانسیو بودن */
    @media (max-width: 768px) {
        .form-group {
            flex-direction: column; /* در صفحه‌های کوچک فیلدها به‌صورت عمودی چیده می‌شوند */
            align-items: flex-start; /* لیبل‌ها به سمت چپ چیده می‌شوند */
        }

        .form-group input,
        .form-group select {
            width: 100%; /* فیلدها عرض کامل می‌گیرند */
        }

        .form-row {
            flex-direction: column; /* در صفحه‌های کوچک فیلدهای تاریخ تولد به‌صورت عمودی چیده می‌شوند */
        }

        .form-row .form-group {
            width: 100%; /* فیلدها عرض کامل می‌گیرند */
        }
    }
</style>
<style>
    .select2-container .select2-selection--single {
        height: 38px;
        padding: 6px 12px;
        direction: rtl;
    }

    .select2-container--default .select2-selection--single .select2-selection__arrow {
        left: 12px;
        right: auto;
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
        text-align: right;
    }
    .success-message {
        background-color: #4CAF50; /* سبز */
        color: white; /* متن سفید */
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 15px;
        display: none; /* به طور پیش‌فرض مخفی است */
        text-align: center; /* متن در وسط */
    }
</style>
{% endblock %}

{% block content %}
<!-- پیام خطا -->


<!-- هدر فرم -->
<div class="container_header">
     <!-- پیام موفقیت -->
     <div id="success-message" class="success-message" style="display: none;"></div>
     <!-- پیام خطا -->
    <div id="error-message" class="error-message" style="display: none;"></div>
    <div class="form-header">
        <h2>افزودن کاربر جدید</h2>
        <a href="/admin/users/"><h2>لیست کاربران</h2></a>
    </div>
</div>

<div class="container">
    <!-- فرم اصلی -->
    <form id="user-form" novalidate>
        {% csrf_token %}

        <!-- فیلدهای فرم -->
        <div class="form-group">
            <label for="first_name">نام</label>
            <input type="text" id="first_name" name="first_name" placeholder="نام را وارد کنید" >
        </div>

        <div class="form-group">
            <label for="last_name">نام خانوادگی</label>
            <input type="text" id="last_name" name="last_name" placeholder="نام خانوادگی را وارد کنید" required>
        </div>

        <div class="form-group">
            <label for="role">گروه کاربری <span class="required-star">*</span></label>
            <select id="role" name="role" required>
                <option value="">گروه کاربری را انتخاب کنید</option>
                <option value="admin">مدیر</option>
                <option value="user" selected>کاربر عادی</option>
                <option value="seller">فروشنده</option>
            </select>
        </div>

        <div class="form-group">
            <label for="mobile">موبایل <span class="required-star">*</span></label>
            <input type="text" id="mobile" name="mobile" placeholder="09121234567" required>
        </div>

        <div class="form-group">
            <label for="password">گذرواژه <span class="required-star">*</span></label>
            <input type="password" id="password" name="password" placeholder="رمز عبور را وارد کنید" required>
        </div>

        <div class="form-group">
            <label for="email">ایمیل</label>
            <input type="email" id="email" name="email" placeholder="ایمیل را وارد کنید">
        </div>

        <div class="form-group">
            <label for="national_code">کد ملی</label>
            <input type="text" id="national_code" name="national_code" placeholder="کد ملی را وارد کنید">
        </div>

        <div class="form-group">
            <label for="national">تبعه هستم</label>
            <input type="checkbox" id="national" name="national">
        </div>

        <div class="form-group">
            <label for="province">استان <span class="required-star">*</span></label>
            <select id="province" name="province" required>
                <option value="">استان را انتخاب کنید</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="city">شهر <span class="required-star">*</span></label>
            <select id="city" name="city" required>
                <option value="">شهر را انتخاب کنید</option>
            </select>
        </div>

        <div class="form-group">
            <label for="region">محله یا روستا</label>
            <input type="text" id="region" name="region" placeholder="محله یا روستا را وارد کنید">
        </div>

        <!-- بخش تاریخ تولد -->
        <div class="form-group">
            <label>تاریخ تولد</label>
            <div class="form-row">
                <div class="form-group">
                    <select id="year" name="year" class="form-control">
                        <option value="">سال</option>
                        <!-- سال‌ها با جاوااسکریپت پر می‌شوند -->
                    </select>
                </div>
                <div class="form-group">
                    <select id="month" name="month" class="form-control">
                        <option value="">ماه</option>
                        <!-- ماه‌ها با جاوااسکریپت پر می‌شوند -->
                    </select>
                </div>
                <div class="form-group">
                    <select id="day" name="day" class="form-control">
                        <option value="">روز</option>
                        <!-- روزها با جاوااسکریپت پر می‌شوند -->
                    </select>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label for="mobile_verified">وضعیت موبایل</label>
            <select id="mobile_verified" name="mobile_verified">
                <option value="mobile_verified">فعال</option>
                <option value="not_verified" selected>غیرفعال</option>
            </select>
        </div>

        <div class="form-group">
            <label for="location">موقعیت جغرافیایی</label>
            <div id="map" style="height: 300px; width: 100%;"></div> <!-- نقشه -->
            <input type="hidden" id="lat" name="lat"> <!-- فیلد مخفی برای عرض جغرافیایی -->
            <input type="hidden" id="lng" name="lng"> <!-- فیلد مخفی برای طول جغرافیایی -->
        </div>

        <!-- دکمه ارسال -->
        <button type="submit" class="btn-submit">افزودن کاربر</button>
    </form>
</div>

<!-- اسکریپت‌ها -->



<!-- افزودن jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- افزودن Select2 -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- افزودن Jalali Moment برای تبدیل تاریخ -->
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment-jalaali@0.9.2/build/moment-jalaali.js"></script>


<script>
    // ارسال فرم با AJAX


    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    
    document.getElementById('user-form').addEventListener('submit', function (e) {
        e.preventDefault();

        const formData = new FormData(this);

        // گرد کردن lat و lng به ۶ رقم اعشار
        const lat = parseFloat(formData.get('lat')).toFixed(6); // گرد کردن به ۶ رقم اعشار
        const lng = parseFloat(formData.get('lng')).toFixed(6); // گرد کردن به ۶ رقم اعشار

        const data = {
            first_name: formData.get('first_name'),
            last_name: formData.get('last_name'),
            role: formData.get('role'),
            mobile: formData.get('mobile'),
            password: formData.get('password'),
            email: formData.get('email') || null,
            national_code: formData.get('national_code') || null,
            province: formData.get('province'),
            city: formData.get('city'),
            region: formData.get('region') || null,
            year: parseInt(formData.get('year')) || null,
            month: parseInt(formData.get('month')) || null,
            day: parseInt(formData.get('day')) || null,
            mobile_verified: formData.get('mobile_verified'),
            lat: lat, // استفاده از مقدار گرد شده
            lng: lng, // استفاده از مقدار گرد شده
        };

        console.log('Data being sent:', data); // بررسی داده‌های ارسالی

        fetch('/api/add-user/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify(data),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const successMessage = document.getElementById('success-message');
                successMessage.innerHTML = 'کاربر با موفقیت ثبت شد!';
                successMessage.style.display = 'block';
                document.getElementById('user-form').reset();
                setTimeout(() => {
                    successMessage.style.display = 'none';
                }, 5000);
            } else {
                const errorMessage = document.getElementById('error-message');
                errorMessage.innerHTML = `
                    <strong>خطا!</strong>
                    <ul>
                        ${Object.entries(data.errors).map(([field, errors]) => `
                            <li>${field}: ${errors.join(', ')}</li>
                        `).join('')}
                    </ul>
                `;
                errorMessage.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });
</script>
<script>
    // تابع برای پر کردن فیلد سال (شمسی)
    function populateYears() {
        const yearSelect = document.getElementById('year');
        const currentYear = moment().format('jYYYY'); // سال جاری شمسی
        const startYear = 1301;

        for (let year = startYear; year <= currentYear; year++) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearSelect.appendChild(option);
        }
    }

    // تابع برای پر کردن فیلد ماه (فارسی)
    function populateMonths() {
        const monthSelect = document.getElementById('month');
        const months = [
            "فروردین", "اردیبهشت", "خرداد", "تیر", "مرداد", "شهریور",
            "مهر", "آبان", "آذر", "دی", "بهمن", "اسفند"
        ];

        months.forEach((month, index) => {
            const option = document.createElement('option');
            option.value = index + 1; // مقادیر ماه‌ها از ۱ تا ۱۲
            option.textContent = month;
            monthSelect.appendChild(option);
        });
    }

    // تابع برای پر کردن فیلد روز
    function populateDays() {
        const daySelect = document.getElementById('day');

        for (let day = 1; day <= 31; day++) {
            const option = document.createElement('option');
            option.value = day;
            option.textContent = day;
            daySelect.appendChild(option);
        }
    }

    // اجرای توابع برای پر کردن فیلدها
    document.addEventListener('DOMContentLoaded', () => {
        populateYears();
        populateMonths();
        populateDays();

        // فعال کردن Select2 برای فیلدهای جستجوپذیر
        $('#year').select2({
            placeholder: "سال را انتخاب کنید",
            allowClear: true
        });

        $('#month').select2({
            placeholder: "ماه را انتخاب کنید",
            allowClear: true
        });

        $('#day').select2({
            placeholder: "روز را انتخاب کنید",
            allowClear: true
        });
    });
    const monthSelect = document.getElementById('month');
</script>


<script>
    // تابع برای دریافت استان‌ها و شهرها از API شما
    function fetchProvincesAndCities() {
        fetch('/load-cities/')
            .then(response => response.json())
            .then(data => {
                const provinceSelect = document.getElementById('province');
                provinceSelect.innerHTML = '<option value="">استان را انتخاب کنید</option>';
                data.forEach(province => {
                    const option = document.createElement('option');
                    option.value = province.name;
                    option.textContent = province.name;
                    provinceSelect.appendChild(option);
                });
                window.provincesData = data;
            })
            .catch(error => console.error('Error fetching provinces and cities:', error));
    }


    // تابع برای پر کردن فیلد شهرها بر اساس استان انتخاب‌شده
    function populateCities(selectedProvince) {
        const citySelect = document.getElementById('city');
        citySelect.innerHTML = '<option value="">شهر را انتخاب کنید</option>';
        const selectedProvinceData = window.provincesData.find(province => province.name === selectedProvince);
        if (selectedProvinceData) {
            selectedProvinceData.cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city.name;
                option.textContent = city.name;
                citySelect.appendChild(option);
            });
        }
    }


    // رویداد تغییر استان
    document.getElementById('province').addEventListener('change', function () {
        const selectedProvince = this.value;
        if (selectedProvince) {
            populateCities(selectedProvince);
        }
    });

    document.addEventListener('DOMContentLoaded', fetchProvincesAndCities);
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // مختصات پیش‌فرض (تهران)
        const defaultLat = 35.6892;
        const defaultLng = 51.3890;

        // ایجاد نقشه
        const map = L.map('map').setView([defaultLat, defaultLng], 13);

        // اضافه کردن لایه نقشه
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // ایجاد مارکر
        let marker = L.marker([defaultLat, defaultLng], { draggable: true }).addTo(map);

        // رویداد برای تغییر موقعیت مارکر
        marker.on('dragend', function (event) {
            const position = marker.getLatLng();
            document.getElementById('lat').value = position.lat; // ذخیره عرض جغرافیایی
            document.getElementById('lng').value = position.lng; // ذخیره طول جغرافیایی
        });

        // رویداد برای کلیک روی نقشه و تغییر موقعیت مارکر
        map.on('click', function (event) {
            const latlng = event.latlng;
            marker.setLatLng(latlng); // تغییر موقعیت مارکر
            document.getElementById('lat').value = latlng.lat; // ذخیره عرض جغرافیایی
            document.getElementById('lng').value = latlng.lng; // ذخیره طول جغرافیایی
        });

        // رویداد تغییر شهر
        document.getElementById('city').addEventListener('change', function () {
            const selectedCity = this.value; // نام شهر انتخاب‌شده
            if (selectedCity) {
                // یافتن شهر انتخاب‌شده در داده‌ها
                const selectedProvince = document.getElementById('province').value;
                const selectedProvinceData = window.provincesData.find(province => province.name === selectedProvince);
                if (selectedProvinceData) {
                    const cityData = selectedProvinceData.cities.find(city => city.name === selectedCity);
                    if (cityData && cityData.lat && cityData.lng) {
                        // تغییر مرکز نقشه به مختصات شهر انتخاب‌شده
                        const lat = parseFloat(cityData.lat);
                        const lng = parseFloat(cityData.lng);
                        map.setView([lat, lng], 13); // تغییر مرکز نقشه
                        marker.setLatLng([lat, lng]); // تغییر موقعیت مارکر
                        document.getElementById('lat').value = lat; // ذخیره عرض جغرافیایی
                        document.getElementById('lng').value = lng; // ذخیره طول جغرافیایی
                    }
                }
            }
        });
    });
</script>


{% endblock %}