{% extends 'mainadmin.html' %}
{% block style %}
    <style>
        .select2-container {
            width: 100%!important;
        }

        .callout {
            padding: 15px;
            margin: 15px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .callout-success {
            background-color: #dff0d8;
            border-color: #d6e9c6;
            color: #3c763d;
        }

        .callout-danger {
            background-color: #f2dede;
            border-color: #ebccd1;
            color: #a94442;
        }
    </style>
{% endblock %}

{% block content %}
<div class="col-lg-10 col-md-8 col-xs-12 content-col pl-0">
    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper" style="min-height: 1008px">
        <!-- Main content -->
        <section class="content">
            <div class="row">
                <div class="col-xs-12">
                    <div class="box">
                        <div class="box-header with-border">
                            <h3 class="box-title">افزودن دسته‌بندی</h3>
                            <div class="box-tools">
                                <div class="input-group input-group-sm">
                                    <a href="https://toosshop.com/admin/categories" class="btn btn-default btn-sm">
                                        لیست دسته‌بندی‌ها
                                        <span class="fa fa-arrow-left"></span>
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- /.box-header -->
                        <div class="box-body">
                            <div class="nav-tabs-custom no-shadow">
                                <ul class="nav nav-tabs">
                                    <li class="active"><a href="#tab_general" data-toggle="tab">عمومی</a></li>
                                    <li><a href="#tab_seo" data-toggle="tab">سئو</a></li>
                                    <li><a href="#tab_information" data-toggle="tab">اطلاعات</a></li>
                                </ul>

                                <form id="form" method="post" enctype="multipart/form-data" class="form-horizontal">
                                    <input type="hidden" name="_token" value="ZopUcPw8uSNjwfbSKGl6U0dWCzFkLR97L9tlAHNk" />

                                    <div class="tab-content">
                                        <div id="error-message" class="callout callout-danger" style="display:none;"></div>
                                        <div id="success-message" class="callout callout-success" style="display:none;"></div>

                                        <!-- Tab General -->
                                        <div id="tab_general" class="tab-pane active">
                                            <div class="form-group">
                                                <label for="name" class="col-md-1 control-label">نام *</label>
                                                <div class="col-md-11">
                                                    <input type="text" name="name" id="name" class="form-control" required />
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label for="latinname" class="col-md-1 control-label">نام لاتین</label>
                                                <div class="col-md-11">
                                                    <input type="text" name="latinname" id="latinname" class="form-control" />
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label for="label" class="col-md-1 control-label">لیبل</label>
                                                <div class="col-md-11">
                                                    <input type="text" name="label" id="label" class="form-control" />
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label for="slug" class="col-md-1 control-label">اسلاگ *</label>
                                                <div class="col-md-11">
                                                    <input type="text" name="slug" id="slug" class="form-control" dir="ltr" required />
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label for="content" class="col-md-1 control-label">توضیحات</label>
                                                <div class="col-md-11">
                                                    <textarea name="content" id="content" class="form-control tinymce"></textarea>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Tab SEO -->
                                        <div id="tab_seo" class="tab-pane">
                                            <div class="form-group">
                                                <label for="meta_keywords" class="col-md-1 control-label">کلمات کلیدی</label>
                                                <div class="col-md-11">
                                                    <textarea name="meta_keywords" id="meta_keywords" class="form-control" rows="3" placeholder="کلمات کلیدی را با خط تیره (-) از هم جدا کنید"></textarea>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label for="meta_description" class="col-md-1 control-label">توضیحات متا</label>
                                                <div class="col-md-11">
                                                    <textarea name="meta_description" id="meta_description" class="form-control" rows="5"></textarea>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Tab Information -->
                                        <div id="tab_information" class="tab-pane">
                                            <div class="form-group">
                                                <label for="parent" class="col-md-1 control-label">دسته والد</label>
                                                <div class="col-md-11">
                                                    <select name="parent" id="parent" class="form-control select2"></select>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label for="sort_order" class="col-md-1 control-label">ترتیب</label>
                                                <div class="col-md-11">
                                                    <input type="number" name="sort_order" id="sort_order" class="form-control" min="0" max="999" />
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label for="icon" class="col-md-1 control-label">آیکون</label>
                                                <div class="col-md-11">
                                                    <input type="file" name="icon" id="icon" class="form-control" />
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label for="image" class="col-md-1 control-label">تصویر</label>
                                                <div class="col-md-11">
                                                    <input type="file" name="image" id="image" class="form-control" />
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label for="banner" class="col-md-1 control-label">بنر</label>
                                                <div class="col-md-11">
                                                    <input type="file" name="banner" id="banner" class="form-control" />
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label for="has_slider" class="col-md-1 control-label">دارای اسلایدر</label>
                                                <div class="col-md-11">
                                                    <input type="checkbox" name="has_slider" id="has_slider" value="1">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label for="status" class="col-md-1 control-label">وضعیت</label>
                                                <div class="col-md-11">
                                                    <select name="status" id="status" class="form-control">
                                                        <option value="0">پیش‌نویس</option>
                                                        <option value="1">انتشار</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="box-footer text-center">
                                        <button type="submit" class="btn btn-primary">افزودن دسته‌بندی</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/5/tinymce.min.js"></script>

<!-- TinyMCE -->
<script>
    tinymce.init({
        selector: "textarea.tinymce",
        height: 300,
        directionality: "rtl",
        menubar: false,
        plugins: [
            "advlist autolink lists link image charmap print preview anchor",
            "searchreplace visualblocks code fullscreen",
            "insertdatetime media table paste code help wordcount"
        ],
        toolbar:
            "undo redo | formatselect | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | help"
    });
</script>

<!-- Form Submission via AJAX -->
<script>
    $(document).ready(function () {
        $('#parent').select2({
            placeholder: 'دسته‌بندی والد را انتخاب کنید',
            allowClear: true,
            ajax: {
                url: '/api/categories', // API برای گرفتن لیست دسته‌ها
                dataType: 'json',
                delay: 250,
                processResults: function (data) {
                    return {
                        results: $.map(data, function (item) {
                            return {
                                text: item.name,
                                id: item.id
                            }
                        })
                    };
                },
                cache: true
            }
        });
        $("#name").on("keyup", function() {
            var slug = this.value.trim()
                .replace(/\s+/g, "-")
                .toLowerCase();
            $("#slug").val(slug);
        });

        // Submit form using AJAX
        $('#form').on('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);

            fetch("https://toosshop.com/admin/categories", {
                method: 'POST',
                headers: {
                    'X-CSRF-TOKEN': $('input[name="_token"]').val()
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) throw new Error("خطا در ارسال درخواست");
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    $('#success-message')
                        .html(data.message || "دسته‌بندی با موفقیت ثبت شد.")
                        .show()
                        .delay(5000)
                        .fadeOut();
                    $('#form')[0].reset();
                } else {
                    let errorHtml = '<ul>';
                    for (let field in data.errors) {
                        data.errors[field].forEach(error => {
                            errorHtml += `<li><strong>${field}:</strong> ${error}</li>`;
                        });
                    }
                    errorHtml += '</ul>';

                    $('#error-message').html('<strong>خطا!</strong>' + errorHtml).show();
                }
            })
            .catch(error => {
                $('#error-message').html(`<strong>خطا:</strong> ${error.message}`).show();
            });
        });
    });
</script>
{% endblock %}